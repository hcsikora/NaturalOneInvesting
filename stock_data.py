import yfinance as yf
import pandas as pd
import matplotlib
import numpy as np
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from datetime import date


class stock_data:
    predictions = {'MMM': -0.2260332962009575,
                   'AOS': -0.24622678019112776,
                   'ABT': -0.1724170559568427,
                   'ABBV': -0.2897528942055996,
                   'ABMD': -0.4149629942185844,
                   'ACN': -0.228120121699909,
                   'ATVI': -0.26320760351527783,
                   'ADM': -0.19579674422786691,
                   'ADBE': -0.38033097651242564,
                   'AAP': -0.23901239233764027,
                   'AMD': -0.36647749685349207,
                   'AES': -0.28350998488351736,
                   'AFL': -0.24020193917972193,
                   'A': -0.2233295903828784,
                   'APD': -0.20256088925797386,
                   'AKAM': -0.36050842469580724,
                   'ALK': -0.40398586205288844,
                   'ALB': -0.32429815677874385,
                   'ARE': -0.29991877373231834,
                   'ALGN': -0.43458538231304367,
                   'ALLE': -0.27334280829980573,
                   'LNT': -0.18684192318224324,
                   'ALL': -0.2342434740647766,
                   'GOOGL': -0.3058750366505383,
                   'GOOG': -0.3058750366505383,
                   'MO': -0.25246942997786265,
                   'AMZN': -0.3390341055389658,
                   'AMCR': -0.19093332825477508,
                   'AEE': -0.17445763327828107,
                   'AAL': -0.5749982392663228,
                   'AEP': -0.20289678240635373,
                   'AXP': -0.33013586961856256,
                   'AIG': -0.3590124390107086,
                   'AMT': -0.19572206764552305,
                   'AWK': -0.19941401463969768,
                   'AMP': -0.23034862240855808,
                   'ABC': -0.08948536238752917,
                   'AME': -0.19318785679870842,
                   'AMGN': -0.19044140486408495,
                   'APH': -0.1983470612684919,
                   'ADI': -0.236255355218504,
                   'ANSS': -0.39941712038139676,
                   'AON': -0.1902408045076413,
                   'APA': -0.5312125483924328,
                   'AAPL': -0.18240684214864245,
                   'AMAT': -0.24020010173033257,
                   'APTV': -0.30093312971097985,
                   'ANET': -0.3123277208449639,
                   'AJG': -0.1600313663380382,
                   'AIZ': -0.21265721473752386,
                   'T': -0.2095697644197289,
                   'ATO': -0.19792801248519512,
                   'ADSK': -0.3976550000703677,
                   'ADP': -0.1730666415397204,
                   'AZO': -0.21061471114234404,
                   'AVB': -0.28428503304659075,
                   'AVY': -0.19473632410673503,
                   'BKR': -0.35449579270696985,
                   'BAC': -0.23414579728319024,
                   'BBWI': -0.3921465935900843,
                   'BAX': -0.19636657068202681,
                   'BDX': -0.19624261238121712,
                   'BBY': -0.20623115237830852,
                   'BIO': -0.34919564012918336,
                   'TECH': -0.36055716625757994,
                   'BIIB': -0.3113982835011049,
                   'BLK': -0.2502873224171087,
                   'BK': -0.267391805241718,
                   'BA': -0.57010087670265,
                   'BKNG': -0.3236952428445577,
                   'BWA': -0.26554816211644444,
                   'BXP': -0.32410916144631957,
                   'BSX': -0.32815608858109147,
                   'BMY': -0.32569385231664355,
                   'AVGO': -0.25696471427277295,
                   'BR': -0.2074502760827922,
                   'BRO': -0.2944612688872173,
                   'CHRW': -0.20858691799497472,
                   'CDNS': -0.34384821976012,
                   'CZR': -0.5944594069288134,
                   'CPB': -0.1979081052124313,
                   'COF': -0.2733813216572492,
                   'CAH': -0.20384729944671037,
                   'KMX': -0.3630951061333399,
                   'CCL': -0.5715454217731725,
                   'CARR': -0.25511601252356153,
                   'CTLT': -0.42200136156187507,
                   'CAT': -0.2001758096831206,
                   'CBOE': -0.23531560708660684,
                   'CBRE': -0.23884916536762332,
                   'CDW': -0.18865491900637035,
                   'CE': -0.21696799023587757,
                   'CNC': -0.2481591018079942,
                   'CNP': -0.22147500318820082,
                   'CDAY': -0.47204165121946784,
                   'CF': -0.3248108749860494,
                   'CRL': -0.44425790263375786,
                   'SCHW': -0.24763460437117618,
                   'CHTR': -0.40259505292320147,
                   'CVX': -0.3455225943039396,
                   'CMG': -0.26288078599145975,
                   'CB': -0.22604323595680756,
                   'CHD': -0.17788301082815233,
                   'CI': -0.17237025337855716,
                   'CINF': -0.23806719485051178,
                   'CTAS': -0.17155202584035298,
                   'CSCO': -0.2323243232901971,
                   'C': -0.3313365063917948,
                   'CFG': -0.31434435938975486,
                   'CLX': -0.2157075667167423,
                   'CME': -0.23574233332839448,
                   'CMS': -0.1832336329644999,
                   'KO': -0.16953173278578035,
                   'CTSH': -0.20883590751888076,
                   'CL': -0.17580171566568534,
                   'CMCSA': -0.32572299718074765,
                   'CMA': -0.32758091888934826,
                   'CAG': -0.17423042674821448,
                   'COP': -0.3182308269366583,
                   'ED': -0.2143486231171038,
                   'STZ': -0.23550229960247765,
                   'CPRT': -0.3126429581324219,
                   'GLW': -0.32890955522786663,
                   'CTVA': -0.2209236921730417,
                   'COST': -0.20573835978816019,
                   'CTRA': -0.32486954365151277,
                   'CCI': -0.18672422757109403,
                   'CSX': -0.2354591619262229,
                   'CMI': -0.19807395109500858,
                   'CVS': -0.20149710333803647,
                   'DHI': -0.2375553823897822,
                   'DHR': -0.22068568173002603,
                   'DRI': -0.19168656299730386,
                   'DVA': -0.28235139418938715,
                   'DE': -0.20886781897832057,
                   'DAL': -0.515512626119999,
                   'XRAY': -0.32443291755861575,
                   'DVN': -0.3542386922131133,
                   'DXCM': -0.3960354602382127,
                   'FANG': -0.5408130621897272,
                   'DLR': -0.24840027253911276,
                   'DFS': -0.3123172470583626,
                   'DISH': -0.4383656694220493,
                   'DG': -0.17467544833209017,
                   'DLTR': -0.2827743877345321,
                   'D': -0.2034445850630275,
                   'DPZ': -0.2668371591516102,
                   'DOV': -0.18644124556312883,
                   'DOW': -0.312744968361758,
                   'DTE': -0.19233870457718238,
                   'DUK': -0.2242109122552161,
                   'DRE': -0.20637722625969648,
                   'DD': -0.3536050948374197,
                   'DXC': -0.48839609945340456,
                   'EMN': -0.24091542326814896,
                   'ETN': -0.17711967031304135,
                   'EBAY': -0.2666983284656272,
                   'ECL': -0.19187256388126783,
                   'EIX': -0.21229284927906292,
                   'EW': -0.2805333753322819,
                   'EA': -0.23919297220072783,
                   'LLY': -0.15080771494814132,
                   'EMR': -0.24497524949363636,
                   'ENPH': -0.4895959734350994,
                   'ETR': -0.20233471280883733,
                   'EOG': -0.31907056476617257,
                   'EFX': -0.21697375232378224,
                   'EQIX': -0.2840751152761284,
                   'EQR': -0.26106205974210683,
                   'ESS': -0.2806838261116786,
                   'EL': -0.1997934898504819,
                   'ETSY': -0.49213621473747904,
                   'RE': -0.23091003965463233,
                   'EVRG': -0.17836211430158383,
                   'ES': -0.18050884409600504,
                   'EXC': -0.2102880383988993,
                   'EXPE': -0.3646804946132404,
                   'EXPD': -0.2162650911053111,
                   'EXR': -0.20319930903636624,
                   'XOM': -0.35144330608812857,
                   'FFIV': -0.35445863798447436,
                   'FB': -0.3879171105989321,
                   'FAST': -0.18730831020975938,
                   'FRT': -0.3217846090722248,
                   'FDX': -0.24182201609575327,
                   'FIS': -0.27589231667986003,
                   'FITB': -0.3140125105625425,
                   'FRC': -0.323203129060241,
                   'FE': -0.33922287579537075,
                   'FISV': -0.30316386140203005,
                   'FLT': -0.30053799171713574,
                   'FMC': -0.19706192269875034,
                   'F': -0.3904962655625351,
                   'FTNT': -0.40353247756554483,
                   'FTV': -0.26223045256343147,
                   'FBHS': -0.2412317376060403,
                   'FOXA': -0.325018635947558,
                   'FOX': -0.325018635947558,
                   'BEN': -0.26260062957165314,
                   'FCX': -0.27967373927730454,
                   'GPS': -0.5367876253576817,
                   'GRMN': -0.2539443713843058,
                   'IT': -0.2683512218658676,
                   'GNRC': -0.45598894416407115,
                   'GD': -0.2369902357525394,
                   'GE': -0.3817213398769427,
                   'GIS': -0.16286631385049316,
                   'GM': -0.33946918951852917,
                   'GILD': -0.2862435036864452,
                   'GPN': -0.2775966941987838,
                   'GL': -0.22774727172872425,
                   'GS': -0.2741842553354532,
                   'HAL': -0.45416749090751374,
                   'HBI': -0.4374416174968485,
                   'HAS': -0.3099387299962754,
                   'HCA': -0.20015744279682907,
                   'PEAK': -0.32580208621679413,
                   'HSIC': -0.22995034422766406,
                   'HES': -0.2949122425290152,
                   'HPE': -0.3094693997146946,
                   'HLT': -0.4850738305789558,
                   'HOLX': -0.30386378256782676,
                   'HD': -0.1675222033857417,
                   'HON': -0.24506523293991844,
                   'HRL': -0.1829337976127674,
                   'HST': -0.4224107279442801,
                   'HWM': -0.4049955347598146,
                   'HPQ': -0.17435388618765044,
                   'HUM': -0.16356550929726196,
                   'HBAN': -0.3244714700435292,
                   'HII': -0.24215729533689165,
                   'IBM': -0.258397224894091,
                   'IEX': -0.24121074603008524,
                   'IDXX': -0.3010960072301401,
                   'ITW': -0.16863886151039797,
                   'ILMN': -0.422143966184318,
                   'INCY': -0.2904973820796023,
                   'IR': -0.3872461971541537,
                   'INTC': -0.2431086462311381,
                   'ICE': -0.30036745375827295,
                   'IFF': -0.308201290083939,
                   'IP': -0.3359679145023026,
                   'IPG': -0.27161366278117915,
                   'INTU': -0.24841442353142532,
                   'ISRG': -0.34983694223320605,
                   'IVZ': -0.2802556886621923,
                   'IPGP': -0.3874015643058994,
                   'IQV': -0.3316751864387447,
                   'IRM': -0.20601085908576466,
                   'JBHT': -0.21295882346150635,
                   'JKHY': -0.28269539147621087,
                   'J': -0.2822671590273894,
                   'SJM': -0.204257593178757,
                   'JNJ': -0.19600857631107652,
                   'JCI': -0.20519161147618079,
                   'JPM': -0.26386872972317854,
                   'JNPR': -0.28092909054644766,
                   'K': -0.15932634084343653,
                   'KEY': -0.3148846205696232,
                   'KEYS': -0.2728143739540934,
                   'KMB': -0.1645934090647267,
                   'KIM': -0.301956187962457,
                   'KMI': -0.34373974428204873,
                   'KLAC': -0.2038306313083808,
                   'KHC': -0.2987341993786084,
                   'KR': -0.10093870989691739,
                   'LHX': -0.18931082938817564,
                   'LH': -0.272143745776959,
                   'LRCX': -0.24797092428640302,
                   'LW': -0.26949024085373885,
                   'LVS': -0.4678909370411635,
                   'LEG': -0.2560858637612556,
                   'LDOS': -0.1893411503431439,
                   'LEN': -0.2988391448939219,
                   'LNC': -0.24906249376091583,
                   'LIN': -0.27879936457225946,
                   'LYV': -0.38494874052441397,
                   'LKQ': -0.21189473457905664,
                   'LMT': -0.19598051668847316,
                   'L': -0.2899869734302031,
                   'LOW': -0.1953857361402735,
                   'LUMN': -0.3232658333854831,
                   'LYB': -0.3432422671235475,
                   'MTB': -0.3016161410100603,
                   'MRO': -0.502770467613588,
                   'MPC': -0.403571663096265,
                   'MKTX': -0.36301235733449777,
                   'MAR': -0.3065303778297132,
                   'MMC': -0.15463696950939632,
                   'MLM': -0.23644294124287263,
                   'MAS': -0.25301889606009403,
                   'MA': -0.18854954111917901,
                   'MTCH': -0.5416536789775527,
                   'MKC': -0.1802804437054412,
                   'MCD': -0.27662632465390513,
                   'MCK': -0.01816637947802753,
                   'MDT': -0.20532501973737177,
                   'MRK': -0.18396946989298782,
                   'MET': -0.23205295503437676,
                   'MTD': -0.24442900067921464,
                   'MGM': -0.4043827713670598,
                   'MCHP': -0.2522036145239024,
                   'MU': -0.2816515207228692,
                   'MSFT': -0.28779551350375904,
                   'MAA': -0.24821178659643106,
                   'MRNA': -0.4105257050082872,
                   'MHK': -0.3286686302456342,
                   'TAP': -0.3479821227913203,
                   'MDLZ': -0.16247810410463687,
                   'MPWR': -0.3195363325599779,
                   'MNST': -0.22981516534772356,
                   'MCO': -0.21267839972137792,
                   'MS': -0.22910639931428695,
                   'MSI': -0.18186413419764083,
                   'MSCI': -0.2555938887190623,
                   'NDAQ': -0.17625107716713845,
                   'NTAP': -0.2211032453239407,
                   'NFLX': -0.4768422076323782,
                   'NWL': -0.31006629012609394,
                   'NEM': -0.30880378977513945,
                   'NWSA': -0.2904986344491948,
                   'NEE': -0.19294026728370572,
                   'NKE': -0.2525235928372582,
                   'NI': -0.21071820544607323,
                   'NSC': -0.19308920163577104,
                   'NTRS': -0.29767210214845113,
                   'NOC': -0.2758002158835272,
                   'NCLH': -0.6553089255419529,
                   'NRG': -0.2926205036525431,
                   'NUE': -0.20931366264768717,
                   'NVDA': -0.3118986512947159,
                   'NVR': -0.21505043749562824,
                   'NXPI': -0.22119226854468382,
                   'ORLY': -0.23729641865614196,
                   'OXY': -0.5353128102717644,
                   'ODFL': -0.23682472897075418,
                   'OMC': -0.21772427621232687,
                   'OKE': -0.38503295738137594,
                   'ORCL': -0.2644701365744539,
                   'OGN': -0.23274187384312256,
                   'OTIS': -0.19848172180285342,
                   'PCAR': -0.2376820051750049,
                   'PKG': -0.19363948787512109,
                   'PH': -0.18017295649453885,
                   'PAYX': -0.18985633073550934,
                   'PAYC': -0.42881786692150087,
                   'PYPL': -0.4500126181999853,
                   'PENN': -0.49631209088225703,
                   'PNR': -0.28081656854916126,
                   'PEP': -0.14413598428838253,
                   'PKI': -0.2894391286075039,
                   'PFE': -0.274316341824046,
                   'PM': -0.24717695605773574,
                   'PSX': -0.28403542558043077,
                   'PNW': -0.20252433305708728,
                   'PXD': -0.3818145849804918,
                   'PNC': -0.3329199809273091,
                   'POOL': -0.26431274366815793,
                   'PPG': -0.18677809387150593,
                   'PPL': -0.3957173308907123,
                   'PFG': -0.23837434328616053,
                   'PG': -0.16663640890995005,
                   'PGR': -0.2464331506204642,
                   'PLD': -0.28697702138233194,
                   'PRU': -0.27015773324919506,
                   'PTC': -0.430081110582196,
                   'PEG': -0.2984362971585061,
                   'PSA': -0.24563174928460849,
                   'PHM': -0.3224763769241501,
                   'PVH': -0.3409191096880211,
                   'QRVO': -0.3580995859588232,
                   'QCOM': -0.22913612447489887,
                   'DGX': -0.20160362391513964,
                   'RL': -0.2609383409547031,
                   'RJF': -0.2580544936662215,
                   'RTX': -0.1937700651872287,
                   'O': -0.31813193428399805,
                   'REG': -0.32651356930689013,
                   'REGN': -0.3458951263573202,
                   'RF': -0.3237224821217156,
                   'RSG': -0.17079501642118683,
                   'RMD': -0.22908493060695165,
                   'RHI': -0.23170616306339475,
                   'ROK': -0.18455612331450957,
                   'ROL': -0.31088267874910647,
                   'ROP': -0.29117055995280805,
                   'ROST': -0.20568362614068406,
                   'RCL': -0.5771403015855471,
                   'SPGI': -0.2266546239561941,
                   'CRM': -0.37651890780736247,
                   'SBAC': -0.31394619601855994,
                   'SLB': -0.2896379045368976,
                   'STX': -0.15915039116597746,
                   'SEE': -0.2841120773339909,
                   'SRE': -0.20237493717691582,
                   'NOW': -0.44473177695391686,
                   'SHW': -0.1845266442311985,
                   'SPG': -0.4013943120155036,
                   'SWKS': -0.23269022578106768,
                   'SNA': -0.27268148938637704,
                   'SO': -0.19990896219232768,
                   'LUV': -0.3383174269097447,
                   'SWK': -0.18241701645105957,
                   'SBUX': -0.19773335495534905,
                   'STT': -0.352955875772459,
                   'STE': -0.2642975890245289,
                   'SYK': -0.2716485656112306,
                   'SIVB': -0.29570412820235814,
                   'SYF': -0.33944244476045043,
                   'SNPS': -0.3719808113872699,
                   'SYY': -0.13909902651119072,
                   'TMUS': -0.3536322141326898,
                   'TROW': -0.21818870201350343,
                   'TTWO': -0.3978231976990177,
                   'TPR': -0.2144489635669635,
                   'TGT': -0.22146877927683772,
                   'TEL': -0.20832090556622535,
                   'TDY': -0.40585042538387905,
                   'TFX': -0.3814498952715534,
                   'TER': -0.32396000836532374,
                   'TSLA': -0.47432117555528697,
                   'TXN': -0.22006928948448473,
                   'TXT': -0.33998665860010324,
                   'COO': -0.35023846958452937,
                   'HIG': -0.2075129745905856,
                   'HSY': -0.1804252126289105,
                   'MOS': -0.2873304140140356,
                   'TRV': -0.19855563954432254,
                   'DIS': -0.37946084285150194,
                   'TMO': -0.20713234543250056,
                   'TJX': -0.36256335284069385,
                   'TSCO': -0.21533489984074045,
                   'TT': -0.21459425469303334,
                   'TDG': -0.333447083262666,
                   'TRMB': -0.3583292584708086,
                   'TFC': -0.3217087322487667,
                   'TWTR': -0.46911822155314165,
                   'TYL': -0.4574923785051337,
                   'TSN': -0.25045489611329635,
                   'USB': -0.31031531394018536,
                   'ULTA': -0.2816888815382437,
                   'UAA': -0.4162661131544556,
                   'UA': -0.5101767759788636,
                   'UNP': -0.1932049983040512,
                   'UAL': -0.5513849022840192,
                   'UPS': -0.2911425840451167,
                   'URI': -0.26590253174673906,
                   'UNH': -0.0730839762618374,
                   'UHS': -0.2777250543171572,
                   'VLO': -0.2916609886563502,
                   'VTR': -0.37303986197591266,
                   'VRSN': -0.33957115727172016,
                   'VRSK': -0.23122504116602685,
                   'VZ': -0.1889059930387972,
                   'VRTX': -0.3424237040695167,
                   'VFC': -0.19572678024270324,
                   'VTRS': -0.364719269179039,
                   'V': -0.34728470069860684,
                   'VNO': -0.3489208525656512,
                   'VMC': -0.19891272799273377,
                   'WRB': -0.2531599542053623,
                   'GWW': -0.188018918967618,
                   'WAB': -0.3099972458699841,
                   'WBA': -0.20211129603004174,
                   'WMT': -0.13721530625400408,
                   'WM': -0.21003848581420922,
                   'WAT': -0.2743226328597932,
                   'WEC': -0.17025907606001028,
                   'WFC': -0.4066189042602335,
                   'WELL': -0.29604223648314215,
                   'WST': -0.3031020721632335,
                   'WDC': -0.37993097000364856,
                   'WU': -0.20736220643132472,
                   'WRK': -0.35781006870682197,
                   'WY': -0.283485978331558,
                   'WHR': -0.19910441520470598,
                   'WMB': -0.27345770918880424,
                   'WYNN': -0.5190745523692267,
                   'XEL': -0.17941151257344518,
                   'XYL': -0.3039064500724967,
                   'YUM': -0.1964236785652744,
                   'ZBRA': -0.2982051171546171,
                   'ZBH': -0.3267132820468382,
                   'ZION': -0.3161677075625949,
                   'ZTS': -0.28009742417866756}

    def __init__(self, ticker):
        self.name = ticker
        self.ticker = yf.Ticker(ticker)

    def get_history(self, years):
        return self.ticker.history(period='{}y'.format(years))

    def get_earnings(self):
        return

    def history_graph(self):

        history = self.get_history(5)

        today = date.today()
        next_year = today.replace(year=today.year+1)
        next_year = pd.Timestamp(next_year.strftime('%Y-%m-%d'), tz='America/New_York')
        loss = history['Close'][-1] + (history['Close'][-1] * -.2)
        next_year = pd.Series([loss], [next_year])
        close = history['Close'].append(next_year)

        plt.clf()
        plt.plot(close)
        plt.title('{} Worst Case Scenario'.format(self.name))
        plt.ylabel('Closing Share Price')
        plt.savefig("static/history.png")
        plt.clf()

    def get_prediction(self):

        if self.name in stock_data.predictions.keys():
            return stock_data.predictions[self.name]

        else:

            return None


    def financials(self):

        return self.ticker.get_cashflow()









